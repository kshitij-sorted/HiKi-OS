#include <stdint.h>
#include <stddef.h>
#include "../../include/drivers/framebuffer.h"

// These will be set from multiboot info or bootloader
uint32_t* framebuffer = 0;
uint32_t screen_width = 0;
uint32_t screen_height = 0;
uint32_t pitch = 0;
uint8_t  bpp = 0;

void fb_init(uint32_t* addr, uint32_t w, uint32_t h, uint32_t p, uint8_t bits_per_pixel) {
    framebuffer = addr;
    screen_width = w;
    screen_height = h;
    pitch = p;
    bpp = bits_per_pixel;
}

void fb_draw_pixel(int x, int y, uint32_t color) {
    if (x >= screen_width || y >= screen_height) return;
    framebuffer[y * (pitch / 4) + x] = color;
}

void fb_clear(uint32_t color) {
    for (uint32_t y = 0; y < screen_height; y++)
        for (uint32_t x = 0; x < screen_width; x++)
            fb_draw_pixel(x, y, color);
}

static const uint8_t font8x8_basic[96][8] = {
    [0] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // Space (ASCII 32)
    [1] = {0x18,0x3C,0x3C,0x18,0x18,0x00,0x18,0x00}, // !
    [2] = {0x6C,0x6C,0x6C,0x6C,0x00,0x6C,0x6C,0x00}, // "
    [3] = {0x6C,0x6C,0x7E,0x6C,0x7E,0x6C,0x6C,0x00}, // #
    [4] = {0x1C,0x36,0x30,0x18,0x30,0x36,0x1C,0x00}, // $
    [5] = {0x63,0x63,0x33,0x1E,0x06,0x33,0x33,0x00}, // %
    [6] = {0x1E,0x33,0x33,0x33,0x33,0x33,0x1E,0x00}, // &
    [7] = {0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00}, // '
    [8] = {0x0C,0x18,0x30,0x30,0x30,0x18,0x0C,0x00}, // (
    [9] = {0x30,0x18,0x0C,0x0C,0x0C,0x18,0x30,0x00}, // )
    [10] = {0x00,0x66,0x66,0x66,0x7F,0x66,0x66,0x00}, // *
    [11] = {0x00,0x18,0x18,0x7F,0x18,0x18,0x00,0x00}, // +
    [12] = {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x10}, // ,
    [13] = {0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0x00}, // -
    [14] = {0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x00}, // .
    [15] = {0x03,0x06,0x0C,0x18,0x30,0x60,0xC0,0x00}, // /
    [16] = {0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0x00}, // 0
    [17] = {0x18,0x38,0x18,0x18,0x18,0x18,0x3C,0x00}, // 1
    [18] = {0x3C,0x66,0x06,0x3C,0x60,0x66,0x3C,0x00}, // 2
    [19] = {0x3C,0x66,0x06,0x3C,0x06,0x66,0x3C,0x00}, // 3
    [20] = {0x66,0x66,0x66,0x7F,0x06,0x06,0x06,0x00}, // 4
    [21] = {0x3F,0x60,0x60,0x3E,0x06,0x66,0x3C,0x00}, // 5
    [22] = {0x3C,0x66,0x60,0x7E,0x66,0x66,0x3C,0x00}, // 6
    [23] = {0x3F,0x66,0x06,0x0C,0x18,0x18,0x18,0x00}, // 7
    [24] = {0x3C,0x66,0x66,0x3C,0x66,0x66,0x3C,0x00}, // 8
    [25] = {0x3C,0x66,0x66,0x3E,0x06,0x66,0x3C,0x00}, // 9
    [26] = {0x3C,0x66,0x00,0x00,0x00,0x00,0x00,0x00}, // :
    [27] = {0x00,0x00,0x00,0x00,0x66,0x66,0x3C,0x00}, // ;
    [28] = {0x00,0x00,0x06,0x18,0x30,0x60,0x00,0x00}, // <
    [29] = {0x00,0x00,0x7F,0x00,0x00,0x7F,0x00,0x00}, // =
    [30] = {0x00,0x00,0x60,0x30,0x18,0x06,0x00,0x00}, // >
    [31] = {0x30,0x30,0x30,0x30,0x30,0x30,0x30,0x00}, // ?
    [32] = {0x3C,0x66,0x63,0x63,0x63,0x63,0x3C,0x00}, // @
    [33] = {0x3C,0x66,0x66,0x66,0x7E,0x66,0x66,0x00}, // A
    [34] = {0x3F,0x66,0x66,0x3F,0x66,0x66,0x3F,0x00}, // B
    [35] = {0x3C,0x66,0x60,0x60,0x66,0x66,0x3C,0x00}, // C
    [36] = {0x3F,0x66,0x66,0x66,0x66,0x66,0x3F,0x00}, // D
    [37] = {0x7F,0x60,0x60,0x7E,0x60,0x60,0x60,0x00}, // E
    [38] = {0x7F,0x60,0x60,0x7E,0x60,0x60,0x60,0x00}, // F
    [39] = {0x3C,0x66,0x60,0x66,0x66,0x66,0x3C,0x00}, // G
    [40] = {0x66,0x66,0x66,0x7F,0x66,0x66,0x66,0x00}, // H
    [41] = {0x3F,0x18,0x18,0x18,0x18,0x18,0x3F,0x00}, // I
    [42] = {0x1F,0x06,0x06,0x06,0x06,0x66,0x3C,0x00}, // J
    [43] = {0x66,0x66,0x6C,0x78,0x6C,0x66,0x66,0x00}, // K
    [44] = {0x60,0x60,0x60,0x60,0x60,0x60,0x7F,0x00}, // L
    [45] = {0x66,0x77,0x77,0x66,0x66,0x66,0x66,0x00}, // M
    [46] = {0x66,0x76,0x7E,0x7E,0x66,0x66,0x66,0x00}, // N
    [47] = {0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0x00}, // O
    [48] = {0x3F,0x66,0x66,0x3F,0x60,0x60,0x60,0x00}, // P
    [49] = {0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0x00}, // Q
    [50] = {0x3F,0x66,0x66,0x3F,0x6C,0x66,0x66,0x00}, // R
    [51] = {0x3C,0x66,0x06,0x3C,0x06,0x66,0x3C,0x00}, // S
    [52] = {0x7F,0x18,0x18,0x18,0x18,0x18,0x18,0x00}, // T
    [53] = {0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0x00}, // U
    [54] = {0x66,0x66,0x66,0x66,0x66,0x3C,0x18,0x00}, // V
    [55] = {0x66,0x66,0x66,0x66,0x77,0x77,0x66,0x00}, // W
    [56] = {0x66,0x66,0x3C,0x18,0x18,0x3C,0x66,0x00}, // X
    [57] = {0x66,0x66,0x3C,0x18,0x18,0x18,0x18,0x00}, // Y
    [58] = {0x7F,0x06,0x0C,0x18,0x30,0x60,0x7F,0x00}, // Z
    [59] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // [
    [60] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // {backslash}
    [61] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // ]
    [62] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // ^
    [63] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // _
    [64] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // `
    [65] = {0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0x00}, // a
    [66] = {0x7F,0x66,0x66,0x7F,0x60,0x60,0x60,0x00}, // b
    [67] = {0x3C,0x66,0x60,0x60,0x66,0x66,0x3C,0x00}, // c
    [68] = {0x7F,0x66,0x66,0x66,0x66,0x66,0x7F,0x00}, // d
    [69] = {0x7F,0x60,0x60,0x7F,0x60,0x60,0x60,0x00}, // e
    [70] = {0x7F,0x60,0x60,0x7E,0x60,0x60,0x60,0x00}, // f
    [71] = {0x3C,0x66,0x60,0x66,0x66,0x66,0x3C,0x00}, // g
    [72] = {0x66,0x66,0x66,0x7F,0x66,0x66,0x66,0x00}, // h
    [73] = {0x3F,0x18,0x18,0x18,0x18,0x18,0x3F,0x00}, // i
    [74] = {0x1F,0x06,0x06,0x06,0x06,0x66,0x3C,0x00}, // j
    [75] = {0x66,0x66,0x6C,0x78,0x6C,0x66,0x66,0x00}, // k
    [76] = {0x60,0x60,0x60,0x60,0x60,0x60,0x7F,0x00}, // l
    [77] = {0x66,0x77,0x77,0x66,0x66,0x66,0x66,0x00}, // m
    [78] = {0x66,0x76,0x7E,0x7E,0x66,0x66,0x66,0x00}, // n
    [79] = {0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0x00}, // o
    [80] = {0x3F,0x66,0x66,0x3F,0x60,0x60,0x60,0x00}, // p
    [81] = {0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0x00}, // q
    [82] = {0x3F,0x66,0x66,0x3F,0x6C,0x66,0x66,0x00}, // r
    [83] = {0x3C,0x66,0x06,0x3C,0x06,0x66,0x3C,0x00}, // s
    [84] = {0x7F,0x18,0x18,0x18,0x18,0x18,0x18,0x00}, // t
    [85] = {0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0x00}, // u
    [86] = {0x66,0x66,0x66,0x66,0x66,0x3C,0x18,0x00}, // v
    [87] = {0x66,0x66,0x66,0x66,0x77,0x77,0x66,0x00}, // w
    [88] = {0x66,0x66,0x3C,0x18,0x18,0x3C,0x66,0x00}, // x
    [89] = {0x66,0x66,0x3C,0x18,0x18,0x18,0x18,0x00}, // y
    [90] = {0x7F,0x06,0x0C,0x18,0x30,0x60,0x7F,0x00}, // z
    [91] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // {
    [92] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // |
    [93] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // }
    [94] = {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00}, // ~
};

void fb_draw_char(char c, int x, int y, uint32_t color) {
    if (c < 32 || c > 127) return;
    const uint8_t* glyph = font8x8_basic[c - 32];

    for (int row = 0; row < 8; row++) {
        uint8_t bits = glyph[row];
        for (int col = 0; col < 8; col++) {
            if ((bits >> col) & 1) {
                fb_draw_pixel(x + col, y + row, color);
            }
        }
    }
}

void fb_write_string(const char* str, int x, int y, uint32_t color) {
    while (*str) {
        fb_draw_char(*str, x, y, color);
        x += 8;
        str++;
    }
}
